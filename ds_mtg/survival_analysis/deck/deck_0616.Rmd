---
title: "Survival Analysis"
subtitle: "GEMINI Data Analysis and Design Meeting"
author: "Charlotte Yuan"
date: "6/16/2022"
output:
  xaringan::moon_reader:
    css: [xaringan-themer.css,custom_deck.css]
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
    seal: false
---

class: titleSlide 

```{r setup, include=FALSE}
library(tidyverse)
library(palmerpenguins)
library(xaringan)
library(xaringanthemer)
library(xaringanExtra)

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.width=9, fig.height=3.5, fig.retina=3, out.width = "100%", cache = FALSE, echo = TRUE, message = FALSE, warning = FALSE, hiline = TRUE)
```

```{r r xaringan-themer, include=FALSE, warning=FALSE}
style_duo_accent(
  primary_color = "#1889c9",
  secondary_color = "#fec52e",
  header_font_google = google_font("Source Sans Pro"),
  text_font_google   = google_font("Libre Franklin", "300", "300i"),
  code_font_google   = google_font("Anonymous Pro"),
  base_font_size = "30px",
  text_font_size = "1rem",
  header_h1_font_size = "2.5rem",
  header_h2_font_size = "2rem",
  header_h3_font_size = "1.25rem",
  padding = "8px 32px 8px 32px",
)
```


# `r rmarkdown::metadata$title`

## `r rmarkdown::metadata$subtitle`

### `r rmarkdown::metadata$author`

#### `r rmarkdown::metadata$date`

<br>

---

class: left

# Introduction

* __Survival analysis__ corresponds to a set of statistical approaches used to investigate the time it takes for an event of interest to occur.  
<br>
* __Survival analysis__ is used in a variety of field such as:
  + _Cancer studies_ for patients survival time analyses 
  + _Sociology_ for “event-history analysis” 
  + _Engineering_ for “failure-time analysis”  
<br>
* In cancer studies, typical research questions are like:  
  + What is the impact of certain clinical characteristics on patient’s survival? 
  + What is the probability that an individual survives 3 years?
  + Are there differences in survival between groups of patients?

---

class: left

# Objectives

* Methods
  + _Kaplan-Meier plots_ to visualize survival curves  
  + _Log-rank test_ to compare the survival curves of two or more groups
  + _Cox proportional hazards regression_ to describe the effect of variables on survival.  
<br> 
* Essential concepts of survival analysis
  + How to generate and interpret survival curves
  + How to quantify and test survival differences between two or more groups of patients.  
<br>
* Continue by describing multivariate analysis using __Cox proportional hazards model__ (July 21st)

---

class: center, middle

# Basic concepts

Survival time and event
<br>
Censoring
<br>
Survival function and hazard function

---

class: left

### Survival time and type of events
* Types of events
  + Relapse
  <br>
  + Progression
  <br>
  + Death
  <br>

---

class: left

### Survival time and type of events
* __Survival time (or time to event)__ is time from ‘response to treatment’ (complete remission) to the occurrence of the event of interest.  
<br>
* The two most important measures in cancer studies include: 
  + Time to death
  + Relapse-free survival time (disease-free survival time/event-free survival time)

---

class: left

### Censoring

.panelset[

.panel[.panel-name[Scenarios]
* Censoring may arise when:
  1. a patient has not (yet) experienced the event of interest, such as relapse or death, within the study time period;
  2. a patient is lost to follow-up during the study period;
  3. a patient experiences a different event that makes further follow-up impossible.
]

.panel[.panel-name[Plot]
```{r echo=FALSE, out.height="70%", out.width="70%", out.align="center"}
knitr::include_graphics('censor.png')
```
]

]

---

class: left

### Survival and hazard functions
* Probabilities used to describe survival data
  - Survival probability: $S(t)$
  - Hazard probability: $h(t)$

---

class: left

### Kaplan-Meier survival estimate
* The Kaplan-Meier (KM) method is a non-parametric method used to estimate the survival probability from observed survival times (Kaplan and Meier, 1958).
The survival probability at time $t_i$, $S(t_i)$, is calculated as follow:
$$S(t_i)=S(t_{i−1})(1−{d_i\over n_i})$$
  - $S(t_{i−1})$ = the probability of being alive at $t_{i−1}$
  - $n_i$ = the number of patients alive just before $t_i$
  - $d_i$ = the number of events at $t_i$
  - $t_0 = 0, S(0) = 1$

---

class: center, middle

# Survival analysis in R

Install and load required R package<br>
Example data sets<br>
Compute survival curves: survfit()<br>
Access to the value returned by survfit()<br>
Visualize survival curves<br>
Kaplan-Meier life table: summary of survival curves<br>
Log-Rank test comparing survival curves: survdiff()<br>
  
---

class: left

### Install and load required R package

.panelset[

.panel[.panel-name[Install]

```{r eval=FALSE}
install.packages(c("survival", "survminer"))
```
]

.panel[.panel-name[Load]
```{r}
library("survival")
library("survminer")
```
]

]
---

class: left

.small[

### Example data sets

```{r}
data("lung")
head(lung)
```

.pull-left[

inst: Institution code  
time: Survival time in days  
status: censoring status 1=censored, 2=dead  
age: Age in years  
sex: Male=1 Female=2  

]

.pull-right[

ph.ecog: ECOG performance score (0=good 5=dead)  
ph.karno: Karnofsky performance score (bad=0-good=100) rated by physician  
pat.karno: Karnofsky performance score as rated by patient  
meal.cal: Calories consumed at meals  
wt.loss: Weight loss in last six months  

]
]


---

class: left

### Compute survival curves: survfit()

.panelset[

.panel[.panel-name[Function]
* The function _survfit()_ [in _survival_ package] can be used to compute Kaplan-Meier survival estimate. Its main arguments include:

  - a survival object created using the function _Surv()_
  - the data set containing the variables
]

.panel[.panel-name[Compute]
```{r}
fit <- survfit(Surv(time, status) ~ sex, data = lung)
print(fit)
```
]

.panel[.panel-name[Summary 1]
```{r}
# Summary of survival curves
summary(fit)
```
]

.panel[.panel-name[Summary 2]
```{r}
# Access to the sort summary table
summary(fit)$table
```
]

]

---

class: left

### Access to the value returned by survfit()

.small[

.panelset[

.panel[.panel-name[Code]
```{r}
d <- data.frame(time = fit$time,
                  n.risk = fit$n.risk,
                  n.event = fit$n.event,
                  n.censor = fit$n.censor,
                  surv = fit$surv,
                  upper = fit$upper,
                  lower = fit$lower
                  )
head(d)
```
]

.panel[.panel-name[Components]
* The function _survfit()_ returns a list of variables, including the following components:

  - n: total number of subjects in each curve.
  - time: the time points on the curve.
  - n.risk: the number of subjects at risk at time t
  - n.event: the number of events that occurred at time t.
  - n.censor: the number of censored subjects, who exit the risk set, without an event, at time t.
  - lower,upper: lower and upper confidence limits for the curve, respectively.
  - strata: indicates stratification of curve estimation. If strata is not NULL, there are multiple curves in the result. The levels of strata (a factor) are the labels for the curves.
]

]

]

---

class: left

### Visualize survival curves

.panelset[

.panel[.panel-name[Code]
```{r eval=FALSE}
# Change color, linetype by strata, risk.table color by strata
ggsurvplot(fit,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          legend.labs = c("Male", "Female"),    # change legend labels
          palette = c("#E7B800", "#2E9FDF"))
```
]

.panel[.panel-name[Plot]
```{r echo=FALSE, fig.height=6, fig.width=16, fig.align="center"}
# Change color, linetype by strata, risk.table color by strata
ggsurvplot(fit,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          legend.labs = c("Male", "Female"),    # change legend labels
          palette = c("#E7B800", "#2E9FDF"))
```
]

]

---

class: left

### Visualize hazard curves

.panelset[

.panel[.panel-name[Code]
```{r eval=FALSE}
ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          fun = "event")
```
]

.panel[.panel-name[Plot]
```{r echo=FALSE, fig.height=6, fig.width=16, fig.align="center"}
ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          fun = "event")
```
]

.panel[.panel-name[Code]
```{r eval=FALSE}
ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          fun = "cumhaz")
```
]

.panel[.panel-name[Plot]
```{r echo=FALSE, fig.height=6, fig.width=16, fig.align="center"}
ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          fun = "cumhaz")
```
]


]

---

class: left

### Kaplan-Meier life table: summary of survival curves

.panelset[

.panel[.panel-name[summary]
```{r}
summary(fit)
```
]

.panel[.panel-name[surv_summary()]
```{r}
res.sum <- surv_summary(fit)
head(res.sum)

attr(res.sum, "table")
```
]

]

---

class: left

### Log-Rank test comparing survival curves: survdiff()
```{r}
surv_diff <- survdiff(Surv(time, status) ~ sex, data = lung)
surv_diff
```

---

class: left

### Takeaways

* __Survival analysis__ is a set of statistical approaches for data analysis where the outcome variable of interest is time until an event occurs.

* Survival data functions
  + Survivor function: an individual survives from the time of origin to some time beyond time t. 
  + Hazard function: having an event at a time, given survival up to that time. 

* How to perform and visualize survival analyses using the combination of two R packages: _survival_ (for the analysis) and _survminer_ (for the visualization).

---

class: center, middle

# Survival Analysis Applied Paper

Survival analysis in gastric cancer: a multi-center study among Iranian patients

---

class: left

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

### Panels

.panelset[

.panel[.panel-name[Panel 1]
text
]

.panel[.panel-name[Panel 2]
```{r}

```
]

]

---



