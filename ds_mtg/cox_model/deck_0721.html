<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Cox Proportional-Hazards Model</title>
    <meta charset="utf-8" />
    <meta name="author" content="Charlotte Yuan" />
    <script src="deck_0721_files/header-attrs/header-attrs.js"></script>
    <link href="deck_0721_files/panelset/panelset.css" rel="stylesheet" />
    <script src="deck_0721_files/panelset/panelset.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="custom_deck.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">


class: titleSlide 






# Cox Proportional-Hazards Model

## GEMINI Data Analysis and Design Meeting

### Charlotte Yuan

#### 7/21/2022

&lt;br&gt;

---

class: left

# Introduction

* __Cox proportional-hazards model__
  + To investigate the association between the survival time of patients and one or more predictor variables  
&lt;br&gt;
* Recap on  __Survival analysis__ 
  + Definition of hazard and survival functions 
  + Construction of Kaplan-Meier survival curves for different patient groups
  + Logrank test for comparing two or more survival curves

---

class: left

# Basics of Cox model 

* Objective
  + To evaluate simultaneously the effect of several factors on survival  
&lt;br&gt; 
* Hazard function  
`$$h(t)=h_0(t)×exp(b_1x_1+b_2x_2+...+b_px_p)$$`
&lt;br&gt;
* Interpretation of hazard ratios (HR)
  + HR = 1: No effect
  + HR &gt; 1 (i.e.: b &gt; 0): Increase in hazard, bad prognostic factor
  + HR &lt; 1 (i.e.: b &lt; 0): Reduction in the hazard, good prognostic factor

---

class: center, middle

# Cox model in R

Install and load required R package&lt;br&gt;
R function to compute the Cox model: coxph()&lt;br&gt;
Example data sets&lt;br&gt;
Compute the Cox model&lt;br&gt;
Check Cox model assumptions&lt;br&gt;
Visualizing the estimated distribution of survival times&lt;br&gt;
  
---

class: left



### Install and load required R package

.panelset[

.panel[.panel-name[Install]


```r
install.packages(c("survival", "survminer"))
```
]

.panel[.panel-name[Load]

```r
library("survival")
library("survminer")
```
]

]

---

class: left

### R function to compute the Cox model: coxph()


```r
coxph(formula, data, method)
```

* formula: a survival object created using the function Surv(): Surv(time, event)
* data: a data frame containing the variables
* method: to specify how to handle ties. The default is ‘efron’. 

---

class: left

.small[

### Example data sets


```r
data("lung")
head(lung)
```

```
##   inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss
## 1    3  306      2  74   1       1       90       100     1175      NA
## 2    3  455      2  68   1       0       90        90     1225      15
## 3    3 1010      1  56   1       0       90        90       NA      15
## 4    5  210      2  57   1       1       90        60     1150      11
## 5    1  883      2  60   1       0      100        90       NA       0
## 6   12 1022      1  74   1       1       50        80      513       0
```

.pull-left[

inst: Institution code  
time: Survival time in days  
status: censoring status 1=censored, 2=dead  
age: Age in years  
sex: Male=1 Female=2  

]

.pull-right[

ph.ecog: ECOG performance score (0=good 5=dead)  
ph.karno: Karnofsky performance score (bad=0-good=100) rated by physician  
pat.karno: Karnofsky performance score as rated by patient  
meal.cal: Calories consumed at meals  
wt.loss: Weight loss in last six months  

]
]

---

class: left

### Compute the Cox model

.small[

.panelset[

.panel[.panel-name[Univariate]

```r
res.cox &lt;- coxph(Surv(time, status) ~ sex, data = lung)
summary(res.cox)
```

```
## Call:
## coxph(formula = Surv(time, status) ~ sex, data = lung)
## 
##   n= 228, number of events= 165 
## 
##        coef exp(coef) se(coef)      z Pr(&gt;|z|)   
## sex -0.5310    0.5880   0.1672 -3.176  0.00149 **
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
##     exp(coef) exp(-coef) lower .95 upper .95
## sex     0.588      1.701    0.4237     0.816
## 
## Concordance= 0.579  (se = 0.021 )
## Likelihood ratio test= 10.63  on 1 df,   p=0.001
## Wald test            = 10.09  on 1 df,   p=0.001
## Score (logrank) test = 10.33  on 1 df,   p=0.001
```

]

.panel[.panel-name[Multivariate]

```r
res.cox &lt;- coxph(Surv(time, status) ~ sex + age + ph.ecog, data =  lung)
summary(res.cox)
```

```
## Call:
## coxph(formula = Surv(time, status) ~ sex + age + ph.ecog, data = lung)
## 
##   n= 227, number of events= 164 
##    (1 observation deleted due to missingness)
## 
##              coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
## sex     -0.552612  0.575445  0.167739 -3.294 0.000986 ***
## age      0.011067  1.011128  0.009267  1.194 0.232416    
## ph.ecog  0.463728  1.589991  0.113577  4.083 4.45e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
##         exp(coef) exp(-coef) lower .95 upper .95
## sex        0.5754     1.7378    0.4142    0.7994
## age        1.0111     0.9890    0.9929    1.0297
## ph.ecog    1.5900     0.6289    1.2727    1.9864
## 
## Concordance= 0.637  (se = 0.025 )
## Likelihood ratio test= 30.5  on 3 df,   p=1e-06
## Wald test            = 29.93  on 3 df,   p=1e-06
## Score (logrank) test = 30.5  on 3 df,   p=1e-06
```
]

]

]

---

class: left

### Cox model assumptions: proportionality

.panelset[

.panel[.panel-name[Code]

```r
surv_sex &lt;- survfit(Surv(time, status) ~ sex, data = lung)
ggsurvplot(surv_sex, 
*          fun = "cloglog",
           conf.int = TRUE,
           xlab = "Natural log of time (days)",
           ylab = "log-log survival",
           title = "log-log curves by sex",
           legend = "bottom", 
           legend.title = "Sex",
           legend.labs = c("Male", "Female"))
```

]

.panel[.panel-name[Plot]
&lt;img src="deck_0721_files/figure-html/unnamed-chunk-8-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.panel[.panel-name[Time-varying]

```r
cox_tt &lt;- coxph(Surv(time, status) ~ sex + tt(sex),
      data = lung, 
      ties = "breslow",
*     tt = function(x, time,...)x*time)
summary(cox_tt)
```

```
## Call:
## coxph(formula = Surv(time, status) ~ sex + tt(sex), data = lung, 
##     ties = "breslow", tt = function(x, time, ...) x * time)
## 
##   n= 228, number of events= 165 
## 
##               coef  exp(coef)   se(coef)      z Pr(&gt;|z|)   
## sex     -0.9489440  0.3871496  0.3038949 -3.123  0.00179 **
## tt(sex)  0.0014225  1.0014235  0.0008317  1.710  0.08719 . 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
##         exp(coef) exp(-coef) lower .95 upper .95
## sex        0.3871     2.5830    0.2134    0.7024
## tt(sex)    1.0014     0.9986    0.9998    1.0031
## 
## Concordance= 0.58  (se = 0.02 )
## Likelihood ratio test= 13.52  on 2 df,   p=0.001
## Wald test            = 12.28  on 2 df,   p=0.002
## Score (logrank) test = 12.82  on 2 df,   p=0.002
```

]

]

---

class: left

### Cox model assumptions: nonlinearity

.panelset[

.panel[.panel-name[Test for linearity]

```r
ggcoxfunctional(Surv(time, status) ~ age + log(age) + sqrt(age), data = lung)
```
]

.panel[.panel-name[Plot]
&lt;img src="deck_0721_files/figure-html/unnamed-chunk-11-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

]

---

class: left

### Visualizing hazards ratio of Cox model

.panelset[

.panel[.panel-name[Code]

```r
cox1 &lt;- coxph(Surv(time, status) ~ age + sex + ph.ecog + meal.cal + wt.loss, data =  lung)
summary(cox1)
hazards &lt;- data.frame(cbind(exp(coef(cox1)), exp(confint(cox1))))
names(hazards)&lt;-c('HR', 'lower', 'upper')
hazards$vars&lt;-rep(c("Age","Sex","ECOG Score","Calories Consumed","Weight Loss"),1)
ggplot(hazards, aes(y= HR, x = reorder(vars, HR))) +
  geom_hline(yintercept = 1, linetype = "dotted", size = 0.8) +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2, color = "grey", size = 1) +
  geom_point(size = 3, color = "#009B96") +
  coord_flip() +
  labs(x = 'Predictors of survival time', y = 'Hazards Ratio (95% CI)') +
  theme_minimal() + 
  scale_y_continuous(limits = c(0, 3))
```
]

.panel[.panel-name[Plot]

&lt;img src="deck_0721_files/figure-html/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

]

---

class: left

### Takeaways

* Cox regression model for assessing the relationship between multiple risk factors and patient’s survival time  
&lt;br&gt;
* How to compute the Cox model using the __survival__ package  
&lt;br&gt;
* How to visualize the results of the analysis using the __survminer__ package  
&lt;br&gt;

---

class: center, middle

# Thank you! 

Questions?

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current%",
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
